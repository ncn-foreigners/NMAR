name: CD - Prod Branch

# on:
#   workflow_run:
#     workflows: ["CI - Dev Branch"]
#     types:
#       - completed
on: workflow_dispatch

jobs:
  check-matrix:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: ["ubuntu-latest"]
        r-version: ["4.4", "release"]

    env:
      GITHUB_PAT: ${{ secrets.PAT }}

    steps:
      - name: Download artifact from CI
        uses: actions/download-artifact@v4
        with:
          name: nmar-package
          # run-id: ${{ github.event.workflow_run.id }}
          workflow: CI - Dev Branch
          branch: package-dev-actions

      - name: List downloaded files
        run: ls -la

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.r-version }}

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          needs: check

      # - name: Extract package name
      #   id: pkg
      #   run: |
      #     PKG_NAME=$(ls *.tar.gz | head -1)
      #     echo "pkg_name=$PKG_NAME" >> $GITHUB_OUTPUT
      #
      # - name: Run R CMD check
      #   uses: r-lib/actions/check-r-package@v2
      #   with:
      #     package: ${{ steps.pkg.outputs.pkg_name }}
      #     args: "--no-manual --no-build-vignettes --as-cran"

  deploy-prod:
    needs: check-matrix
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: package-dev-actions
          fetch-depth: 0

      - name: Remove dev files
        run: |
          rm -rf src/
          rm -f build_r_folder.R
          echo "Dev files removed"

      - name: Setup Git config
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Commit and push to production branch
        run: |
          git checkout -B package-prod
          git add .
          git commit -m "Production release from CI: ${{ github.sha }}" || echo "No changes to commit"
          git push origin package-prod --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
