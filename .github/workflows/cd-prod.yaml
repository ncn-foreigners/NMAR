name: CD - Prod Branch

on:
  push:
    branches: [ package-prod ]
  pull_request:
    branches: [ package-prod ]
    types: [closed]

jobs:
  build-and-check-clean-package:
    if: github.event.pull_request.merged == true || github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Remove dev files (src/ and build script)
        run: |
          rm -rf src/
          rm -f build_r_folder.R
          echo "Development files removed."

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'

      - name: Install dependencies
        run: |
          R -e "install.packages('devtools')"
          R -e "devtools::install_deps(dependencies = TRUE)"

      - name: Build clean package tarball
        run: R CMD build . --no-build-vignettes

      - name: Run R CMD check on clean package
        run: R CMD check *.tar.gz --no-manual --no-build-vignettes --as-cran

      - name: List files in the clean package (verification)
        run: tar -ztf *.tar.gz
