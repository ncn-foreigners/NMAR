---
title: "NMAR"
format: 
  revealjs:
    theme: ["./quadro/q-theme.scss"]
    code-overflow: wrap
    highlight-style: a11y
    height: 1080
    width: 1920    
    scrollable: true
    html-math-method: mathjax
    slide-number: true
    embed-resources: true
editor: visual
---

## NMAR: An R Package for Estimation under Nonignorable Nonresponse in Sample Surveys

::: hidden
$$\everymath{\displaystyle}$$
:::

### Tackling Nonignorable Missingness in Official Surveys with R

<hr>

#### National Science Centre grant Poland (OPUS 20 grant no. 2020/39/B/HS4/00941)

<br>

#### dr Maciej Beręsewicz (Poznan University of Business and Economics),<br> Igor Kołodziej (WUT - Faculty of Mathematics),<br> Mateusz Iwaniuk (WUT - Faculty of Mathematics)

<br>

> NMAR - Not Missing At Random

::: {style="text-align: right;"}
<img src="./logo.PNG" alt="Logo" style="height: 550px;position:fixed;right:50px;bottom:100px"/>
:::

## Motivation: The Challenge of Nonignorable Nonresponse (NMAR)

1.  **Missing Data Structure**: We are interesting in estimating the mean of $Y$ which is subject to missingness. Each observation $y_i$ has its corresponding respone indicator $\delta_i$:

> $$
> \delta_i = \begin{cases} 
> 1 & \text{if } y_i \text{ is observed} \\
> 0 & \text{if } y_i \text{ is missing}
> \end{cases}
> $$

2.  **Outcome Mechanism**: Having a set of auxiliary covariates $X_1$, we model

$$\mathbb{P}(Y \mid X_1) \text{, or nonparametric } F(Y, X_1)$$

3.  **Response Mechanism**: The missingness of $Y$ depends on $Y$ itself, and perhaps on other covariates $X_2$

$$P(\delta=1\mid Y, X_2) \neq P(\delta=1\mid X_2)$$

**Note**: The sets of auxiliary and response model covariates may or may not overlap depending the method.

## Practical Example: Salary Survey

**Scenario**: Richer people tend not to answer questions about salary

> $Y$: Salary (with missing values) <br> $\delta$: Response indicator (1 = answered, 0 = refused)

<br>

**Outcome Mechanism** :

> $Y \sim \text{experience} + \text{education}$

<br>

**Response Mechanism**:

Assuming that apart from salary, it is also affected by age

> $\delta \sim Y + \text{age}$

## The Case of the Missing Salaries

::: {style="text-align: center;"}
<img src="./quadro/nmar_boxplot.png" alt="Simulation Results" style="width: 70%;"/>
:::

> NMAR estimators are closer to true population mean compared to MAR estimators, naive sample mean is badly biased.

## Exponential Tilting - Riddles et al (2016) (1/2)

### Assumptions

-   Estimate density of observed data: $f(y|X_1, \delta = 1)$, e.g., salary $\sim$ experience + education
-   Use response model (logit/probit) to estimate $\pi(x_{1i}, y_i; \phi) = P(\delta_i = 1 | X_{2i}, y_i)$ based on $y$ (e.g. salary), $X_2$ (e.g., age), and intercept

### 1. Estimate Observed Distribution

> $$
> \hat{f}_1(y) = f(y|X_1, \delta = 1; \gamma)
> $$

### 2. Define score function

::: {style="font-size: 26px;"}
> $$
> S_{\text{obs}} = \sum_{j:\delta_j=1} s(y_j, X_{1j}) = \sum_{j:\delta_j=1} \left[ \frac{\delta_j - \pi(X_{1j}, y_j; \phi)}{\pi(X_{1j}, y_j; \phi)\{1-\pi(X_{1j}, y_j; \phi)\}} \frac{\partial \pi(X_{1j}, y_j; \phi)}{\partial \phi} \right]
> $$

> $$ 
> S_{\text{mis}} = \sum_{j:\delta_j=1} \sum_{i:\delta_i=0} w_{ji} \cdot s(y_j, X_{1i}) = \sum_{j:\delta_j=1} \sum_{i:\delta_i=0} w_{ji} \cdot \left[ \frac{\delta_i - \pi(X_{1i}, y_j; \phi)}{\pi(X_{1i}, y_j; \phi)\{1-\pi(X_{1i}, y_j; \phi)\}} \frac{\partial \pi(X_{1i}, y_j; \phi)}{\partial \phi} \right]
> $$
:::

## Exponential Tilting - Riddles et al (2016) (2/2)

### 3. Calculate weights

> $$
> w_{ji}^*(\phi, \gamma) = \frac{\frac{O(\mathbf{x}_{1i}, y_j; \phi) f_1(y_j|\mathbf{x}_i; \gamma)}{\sum_m f_m(y_j|\mathbf{x}_i; \gamma)}}{\sum_{k:\delta_k=1} \frac{O(\mathbf{x}_{1i}, y_k; \phi) f_1(y_k|\mathbf{x}_i; \gamma)}{\sum_m f_m(y_k|\mathbf{x}_i; \gamma)}}
> $$

### 4. Solve Final Equation

> $$
> S_{\text{total}} = S_{\text{obs}} + S_{\text{mis}} = 0
> $$

### 5. Estimate Population Mean

> $$
> \mathbb{E}[Y] = \hat{\theta} = \frac{\sum_{i:\delta_i=1} \frac{1}{\pi_i(\hat{\phi}_p)} y_i}{\sum_{i:\delta_i=1} \frac{1}{\pi_i(\hat{\phi}_p)}}
> $$

## Empirical Likelihood: Core Idea (1/2)

**Based on Qin, Leung & Shao (JASA, 2002).** Model only the **response mechanism**; keep the outcome distribution **nonparametric**.

> $$
> w(y, x; \beta) = P(\delta = 1 \mid Y=y, X=x) \quad (\text{e.g., logit/probit}), \qquad W = \iint w(y, x; \beta) \, dF(y, x).
> $$

**Profile out** $F$ (for fixed $(\beta, W)$) by placing masses $p_i$ on respondents $(y_i, x_i)$ and enforcing:

> -   $\sum p_i = 1$ (probability)
> -   $\sum p_i \{ w(y_i, x_i; \beta) - W \} = 0$ (response rate)
> -   $\sum p_i (x_i - \mu_x) = 0$ (auxiliaries, if available)

This yields the EL **weights**

> $$
> p_i = \frac{1}{n} \frac{1}{1 + \lambda_W (w(y_i, x_i; \beta) - W) + (x_i - \mu_x)^\top \lambda_x}.
> $$

## Empirical Likelihood: Mean Estimate (2/2)

> $$
> \hat{\mu}_Y = \sum_{i:\delta_i=1} p_i y_i
> $$

#### How are the weights obtained?

Profile out $F$ and solve the estimating equations for $(\beta, W, \lambda_W, \lambda_x)$, plug back into the formula for $p_i$.

</br>

#### Survey sampling?

Can be extended to survey sampling by incorporating the design weights into the likelihood and augumenting auxiliary constraints with stratum indicators.

</br>

#### Properties

-   Consistent if the response model $w(y, x; \beta)$ is correctly specified.
-   Asymptotically normal (under regularity conditions).
-   Auxiliaries improve efficiency.

## NMAR Package in Action

```{r}
#| echo: false
#| message: false
#| warning: false
devtools::load_all()
```

```{r}
#| echo: false
#| message: false
# Function to generate testdata, basing on riddle(2016)
generate_test_data <- function(n_rows = 500, n_cols = 1, case = 1, x_var = 0.5, eps_var = 0.9, a = 0.8, b = -0.2) {
# Generate X variables - fixed to match comparison
  X <- as.data.frame(replicate(n_cols, rnorm(n_rows, 0, sqrt(x_var))))
  colnames(X) <- paste0("x", 1:n_cols)

# Generate Y - fixed coefficients to match comparison
  eps <- rnorm(n_rows, 0, sqrt(eps_var))
  if (case == 1) {
# Use fixed coefficient of 1 for all x variables to match: y = -1 + x1 + epsilon
    X$Y <- as.vector(-1 + as.matrix(X) %*% rep(1, n_cols) + eps)
  }
  else if (case == 2) {
    X$Y <- -2 + 0.5 * exp(as.matrix(X) %*% rep(1, n_cols)) + eps
  }
  else if (case == 3) {
    X$Y <- -1 + sin(2 * as.matrix(X) %*% rep(1, n_cols)) + eps
  }
  else if (case == 4) {
    X$Y <- -1 + 0.4 * as.matrix(X)^3 %*% rep(1, n_cols) + eps
  }

  Y_original <- X$Y

# Missingness mechanism - identical to comparison
  pi_obs <- 1 / (1 + exp(-(a + b * X$Y)))

# Create missing values
  mask <- runif(nrow(X)) > pi_obs
  mask[1] <- FALSE # Ensure at least one observation is not missing
  X$Y[mask] <- NA

  return(list(X = X, Y_original = Y_original))
}

set.seed(1109)
res_test_data <- generate_test_data(n_rows = 500, n_cols = 2, case = 1)
x <- res_test_data$X
y_original <- res_test_data$Y_original # to compare with true values
```

```{r}
#| echo: true
#| message: false
#| warning: false
exptilt_config <- exptilt_engine(
    standardize = FALSE, #Common
    on_failure = "return", # Common
    variance_method = "bootstrap", #Common
    bootstrap_reps = 20, # Common
    control = list(), # Common
    family = "logit", # Common
    y_dens = "normal",
    stopping_threshold = 1
)
formula = Y ~ x1 + x2
res <- nmar(formula = formula, data = x, engine = exptilt_config, trace_level=0)
```

```{r}
#| echo: true
#| message: false
#| warning: false
print(res)
```

```{r}
#| echo: true
#| message: false
#| warning: false
coef(res)
```

```{r}
#| echo: false
#| message: false
#| warning: false
cat('True Y mean:          ', sprintf('%.4f', mean(y_original)), '\n')
est <- as.numeric(res$y_hat)
se <- res$se
cat('Est Y mean (NMAR):    ', sprintf('%.4f', est),
    '  3σ interval: (', sprintf('%.4f', est - 1.5 * se),
    ', ', sprintf('%.4f', est + 1.5 * se), 'σ=', sprintf('%.4f', se), ')\n')
cat('Naive Y mean (MAR):   ', sprintf('%.4f', mean(x[!is.na(x$Y), 'Y'])), '\n')
```

## Improving R folder

::: {style="text-align: center;"}
<img src="./quadro/src_dev.png" alt="Simulation Results" style="height: 600px;"/> <br/> <img src="./quadro/R.png" alt="Simulation Results" style="height: 400px;"/>
:::

## CI/CD via Github Actions

::: {style="text-align: center;"}
<img src="./quadro/cidev.png" alt="Simulation Results" style="height: 400px;"/>

<img src="./quadro/pages_build.png" alt="Simulation Results" style="height: 500px;"/>
:::

## Future Work and Challenges

-   Analytical variance calculation
-   Extension to new estimation approaches
-   Extending estimation parameters beyond mean (quantiles, gini index)
-   Rewriting Exptilt EM and Likelihood Jacobians in C/C++ for improved performance
-   Large-scale data handling

## References

-   Qin, J., Leung, D., & Shao, J. (2002). Estimation With Survey Data Under Nonignorable Nonresponse or Informative Sampling. Journal of the American Statistical Association, 97(457), 193–200. https://doi.org/10.1198/016214502753479338
-   Minsun Kim Riddles, Jae Kwang Kim, Jongho Im, A Propensity-score-adjustment Method for Nonignorable Nonresponse, Journal of Survey Statistics and Methodology, Volume 4, Issue 2, June 2016, Pages 215–245, https://doi.org/10.1093/jssam/smv047
